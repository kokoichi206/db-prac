## SQL インジェクション

根本的対策

- バインド機構を利用すること
  - なんらかの理由でバインド機構で実装できない場合は、エスケープ処理による対策も必要
- SQL にとって特別な意味を持つ記号（メタ文字）はデータベースエンジンによって異なる
  - → 環境に応じて対策が必要

## リテラル

``` sql
SELECT name, age FROM users WHERE name = 'John' AND age > 20;
```

SQL を構成する要素

- キーワード（予約語）
  - SELECT, FROM, WHERE, AND
- 演算子など
  - `= >= ,`
- 識別子
  - name age users
- リテラル
  - 'John' 20

文字列リテラルや数値リテラル、論理値リテラルなどがある。

文字列の中に ' が入ってたりする場合は、それをエスケープして '' とする。

アプリケーションとして扱う際は、リテラル部分をパラメータ化する事が一般的。
ここで生成される分を正しくエスケープ処理する必要がある。

文字列リテラルに対する SQL インジェクション

パラメータを正しくリテラルとして展開する事が必要

- 文字列リテラルに対しては、エスケープすべき文字列をエスケープさせること
- 数値リテラルに対しては、数値以外の文字を混入させないこと
  - 型のない言語で注意

通常の文字列結合では不都合が生じることをみる。

## プレースホルダとバインド機構

パラメータを表す部分（go では $1, $2,...）のことをプレースホルダとよび、そこへ実際の値を割り当てることを『バインド』という。

プレースホルダの組み立て2つ

- 静的プレースホルダ
  - Prepared Statement
  - SQL を準備する段階で SQL の文が確定する
    - 後から構文が変化する事がなく安全！
- 動的プレースホルダ
  - プレースホルダを利用するものの、パラメータのバインドをアプリのライブラリ内で実行
    - ライブラリ側の実装によるところが大きいため、場合によっては脆弱
  - クライアントサイドのプリペアードステートメント



## Links

- [全てのインジェクション対策は「命令」と「データ」を確実に分離することで対策可能](https://blog.ohgaki.net/injection-prevention-basic)
  - KVS（Key Value Store）がSQLデータベースより安全であるのは、インターフェースレベルで命令とデータを完全に分離しているから
- [安全な SQL の呼び出し方](https://www.ipa.go.jp/security/vuln/websecurity/ug65p900000196e2-att/000017320.pdf)
